#自我介绍2015.04.22.完美世界

@(草稿)[自我介绍]

###项目经历以及个人介绍

您好,我是南京大学的王选易,我擅长的框架是Unity，Cocos2d-x，我目前比较喜欢的语言是C#，对Lua和C++也比较熟悉。
我目前使用的IDE是Visual Studio，对Unity编辑器的各种操作也基本烂熟于心。
我的简历里面有我的博客和GitHub链接，您可以先看看。

虽然也曾经刷过算法题，但是我对自己的算法水平还是不是很有信心，但是实际工作中用到的算法我还是比较了解的。

我在大学里参加过多个游戏项目，也曾经自己独立做过一些项目。对游戏中的游戏主循环，渲染系统，动画系统，AI，网络，碰撞和游戏性系统都略有研究，目前在腾讯和米哈游都实习过，分别体验了国内大公司和创业公司的工作。

继续介绍一下我在学校和实习中的项目经历：

###仙林奇侠传

整个的游戏设计是模仿仙剑奇侠传，传统的回合制战斗+迷宫式踩怪+线性剧情的设计，用的是JavaSE的平台，虽然不像直接在DX或者OpenGL上写程序那么辛苦，但是还是要写很多的基础模块和工具。现在看当时的底层模块用的是继承样式的架构，不适用的组件的架构。

印象深刻的模块：

####编写关卡解释器

因为当时没啥经验，还不太会用JSON和XML，就把线性剧情序列化为类似CSV的格式，将整个剧情分成几个阶段，每个阶段里面分别序列化成一个CSV文件，CSV文件中标记了在这个阶段应该有的NPC，怪物的种类等等，然后玩家在进入小地图时每个地图分别判断是否应该显示相应的NPC和怪物。
类似这种：

    #Condition
    Phase01
    
    #Scene
    map03
    
    #NPC
    01， 03， 04
    
    #Monster
    02， 05， 06
    
    #Dialogue
    01：haha
    02：hehe

在玩家进入每个关卡时，读取响应的CSV文件，若是有与它相关的数据，如果有的话，就将相应的数据载入

####编写地图编辑器

地图编辑器实际上是实现了一个类似于Tiled和RPGMaker那种Tile-Based的瓦片式地图编辑器，方便编辑和生成迷宫，最后生成的数据格式其实也和TMX格式差不多吧，只是功能少了很多。

处理这种地图编辑器比较恶心的地方就是z-order的问题，很多时候会发生不同的瓦片相互遮挡的问题，如果人物会和地图再次产生相互交错的现象就更加麻烦了。这时就要引入分层的概念，比如将地图分为地砖，建筑，人物这样的几层，调整好每一层的优先级。

####编写主循环

游戏战斗中的动画主要使用的是帧动画，其实这个我们也没得选，因为盗用的天之痕的素材用的都是帧动画，所以需要自己一帧帧调节动画的位置，当时真是辛苦。

其实大一的时候自己心中还没有游戏主循环这个概念，但在现在看看自己就是在写一个游戏的主循环，当时我们讨论的时候还在思考要不要用多个线程处理战斗，因为游戏中会“同时”发生战斗逻辑和渲染事件，现在我明白了，其实游戏的主循环可以在一帧里先处理逻辑事件，再处理渲染事件，对应到U3D中就是Update和LateUpdate，也就是把逻辑帧和渲染帧分离。

当时还没有将这两者分离的概念，导致很多代码耦合严重，笑

####双缓冲

为了防止在渲染时候出现闪烁现象，使用了swap buffer的双缓冲技术。

####A*算法

###XiHad

XiHad是我大学三年级时做的一个项目，目标制作一个战旗游戏，当时是想从Irricht这个图形库上构建一个游戏引擎，整体设计抄的是Unity，为了降低耦合使用了组件式架构。但是最后由于引擎做的时间太长，加上没有美工，最后项目挂了。

印象深刻的模块

####编写战斗状态机

其实这次的战棋游戏的项目很多特性和之前做的仙林奇侠传那个项目有很多相似的地方，都是回合制战斗，但是之间的战斗逻辑写的很乱，究其原因还是没有使用有限状态机来处理游戏中的战斗逻辑。

使用有限状态机有利于游戏战斗中各种状态的转换和撤销，也使得游戏中不同的战斗逻辑的数据和行为得到分离。控制战斗的状态机的状态转换一般是由玩家的输入来驱动的，但有时也会被一些消息（Message）所驱动，如游戏开始，游戏结束等等。

状态机要提供OnEnter，OnExit和OnUpdate接口来执行通用的调用，同时也需要可以监听各种消息，并且对每种消息执行相应的回调函数

####编写AI

编写AI的时候，用到了很多Lua中的协程，Lua中的协程和U3D中的协程很像，都可以被看成一个可以多次进入的函数，而且这个函数可以保存上下文，我们可以把它看成是一个简化的有限状态机。

####编写Tween插值动画系统

在Xihad项目中我使用Lua实现了一个类似Unity中的iTweens的创造Tween动画的库，以此来实现战棋游戏中的各种移动如摄像机移动，人物移动等等，并实现了跟随，旋转，循环，缩放等功能。

###Four

Four是一个类似五子棋的棋类游戏，这个游戏从美术到代码都是我一个搞定的。

印象深刻的模块：

####表现与逻辑分离

在编写Four的时候，我使用了MVC架构来构建整个游戏。其中Controller层负责将界面上的各种触摸事件转化为游戏内的消息，转发给Model层，Model层是一个有限状态机，它接收到消息后，根据消息进行相应的状态转换，然后将状态转化中发生的消息通知给View层，View在响应的回调函数中写清楚每个消息的处理方法，这样就把游戏的各个逻辑进行了有效的解耦。
在编写游戏的对弈AI时，我使用了极大极小算法，这是在零和博弈下的一种评分策略，最终导致我的游戏AI几乎每一次都能获胜。

####各种Cocos2d-x的坑

在这次编写Four的过程中，我也遇到了许多Cocosd2d-x使用的各种陷阱。比如说：

- 内存管理：
- 不完善的编辑器：
- 用C++写逻辑带来的问题：宏，热更新，编译慢

所以，我在写完这个项目之后渐渐把自己的学习重心放到了Unity上，因为Unity提供了一个较为完善的编辑器和工具链，还有C#这种比较完善的语言和VS这种好用的IDE，在接下来几个月里，我越发感觉到Unity才是更适合手机游戏的解决方案。

###在腾讯实习印象深刻的模块：

在腾讯的时候，我主要负责仓库系统和游戏内UI的重构和开发工作

####网络传输和加密

由于之前在学校的项目大部分都是没有网络模块的，这次在腾讯的时候对网络传输和加密有了一定的学习和了解。

- RSA加密
- 秘钥交换
- 异或内存加密

####做工具

在游戏开发中，要多多使用UnityEditor相关的API，尽量解放自己的双手，多开发一些工具完成一些重复性的工作。比如，调整UI的深度值，调整界面音效，调整背景图片等等。

####各种优化手段

说起游戏的优化，在游戏开发中经常分为这几步：

- 首先要确定游戏中经常会出现哪些问题 - Profile 
- 然后确定在哪些方向进行性能优化 - Analyze
- 最后再尽可能将问题逐个解决 - Solve

游戏开发中一定是先做工具，进行Profile，再进行优化，所以，说优化就不得不再扯一下Profile

常见的工具有一些是引擎和IDE自带的，比如Unity自带的Profiler，就包含了CPU，GPU，Memory等等各式各样的性能分析工具，其他的比如GPA，Xcode Instrument和Visual Studio，Intel自带的内存管理工具在必要的时候也使需要去学习和使用的。

另外一些工具，就需要根据游戏的需求去编写了，比如一键关闭所有特效，一键更改分辨率等等，一键设置场上NPC数量，简单的游戏如啪啪三国是做成快捷键开启Profile功能的，更为复杂的游戏如神秘海域则是通过游戏内控制台来进行更为细致的Profie。

接着，我们再来说说游戏优化中主要的四个考虑方向：

1、CPU
引发的问题：
- 由于短时间内的计算量太大，导致画面流畅性降低，俗称跳帧
- 发热严重，耗电量高

常见的优化手段：
- 将计算分到多个逻辑帧中进行计算，避免短时间内的性能超过负荷，俗称“分帧”（time-slice）。
- 将可以缓存的数据尽可能的缓存起来，避免重复计算和重复分配内存，常见的示例为“内存池”。
- 使用合理的算法和数据结构，比如：冒泡排序和直接插入排序在整体数组比较有序的情况下效率大大好于快速排序。把快排替换成是优化程序排序效率的一个常见的思路。
2、GPU
引发的问题：
- 发热严重，耗电量高
- FPS降低
常见的优化手段：
- 优化美术资源，比如合理规划图集，约定好模型的最大三角形面数，制定合理的粒子效果规范。这个可以说是游戏优化中最重要的一个，因此，技术美术在游戏开发中作用巨大。
- 简化或者优化着色器（shader）
- 使用Batching，尽量减少DrawCall
- 使用平台推荐的压缩格式，比如安卓平台的ETC1和IOS平台的PVRTC

3、IO和网络
引发的问题：
- 网络延迟甚至掉线
- 加载资源导致的跳帧
- 加载时间过长
- 常见的优化手段：
-  使用独立的线程进行加载，有些引擎如Unity中还能利用协程
- 减少网络包里面的冗余数据
- 合并小包，减少请求数据的次数
- 分帧对回包进行处理
- 限制一定时间内的发包频率

4、内存
引发的问题：
- 闪退和卡死，比如安卓的Low Memory Killer会在低内存情况下杀掉内存占用过大的程序。

常见的优化手段
- 动态加载和卸载资源，比如在游戏内的时候，我们可以把游戏外的一些UI图集卸载掉。
- 降低资源质量或屏幕分辨率，这是有损优化，一般作为最后的手段

其实这四个方面的优化总是相互制衡的，你把一个方面的优化做好了，另一个方面的问题又会出现了，比如，我们如果使用动态加载和卸载资源，这就虽然减少了内存占用量，会在IO上造成加载时间延长的问题。

所以，我们在做游戏优化的时候，不能太追求完美，刚刚好就是真的好（Good Enough Is Fine）。最终使得以上这四个方面能达到均衡即可，切忌在某一方面优化过头，又引发其他方面的问题，此消彼长的情况下，有时反而不如不做优化。

####各种U3D和NGUI的坑
在开发过程中，也经历并解决了很多NGUI和Unity的“坑”。您可以就一些U3D的问题对我进行提问。

###对腾讯实习的一些反思

在7月到10月我一直在腾讯实习，这几个月里虽然加班加点，参与了“全民突击”这款非常棒的游戏的开发工作，但是在米哈游工作一段时间后，我愈发想检讨自己在腾讯的一些工作。

在腾讯的时候，100来人的团队，每个人各司其职，这样效率固然提高了，但是对个人的发展未必是好事。

这几个月里，我的思维一直被局限住了而不自知，虽然游戏的代码中有很多的精妙之处，不过由于团队也是刚刚接触Unity3D，哪里都不乏可以修正增益之处，回头想想，无论是工具，编辑器还是代码结构，每个地方都有可以进行变更之处，但是囿于这种螺丝钉式的思维，最终我却只是完成了我的本职工作，没有提出改进，也没有向他人学习更多，来补足自己的知识漏洞（如游戏的后台开发，部署等等）。

另一方面，回首在腾讯的几个月里，实在是没有留下多少值得在今后的面试里面大书特书的代码，这点其实主要是我的问题，没有合理的分配时间，把更多的精力献给社区和博客。

###寻找实习机会

其实来到米哈游之前，我还曾经在莉莉丝面试过实习生，莉莉丝的很多员工都是南大的学长，对我还是非常nice的，异常迅速的给我发了面试的邀请，其实前几面过的很顺利，最后一面里，因为我不想继续在Cocos2d-x和Lua的框架上写代码，准备做的不是很充分，最后刀塔传奇的制作人给我下了个结论：“`做的东西都很简单，没什么技术含量`”。面试自然在不是很愉快的情况下结束了。

这次面试失败给我敲响了警钟：

- 面试前一定要做充分的准备，要对自己做过的每一个项目都的各种细节做到知无不尽，如果面试官开始问你`和你本人无关`的问题了，那么你的面试就基本上失败了。
- 在腾讯的工作真的太细化了，这样很容易让当时的我产生惰性心理，不去学习其他方面的知识，贻害无穷。

米哈游的实习来的比较有趣，本来米哈游是不招实习生的，所以投了简历之后杳无音讯，之后我尝试直接联系大伟哥，经过一些了解之后，确定了去上海本地面试，这次充足的准备使得我比较顺利地通过了笔试和面试，最终得到了这份实习。

###我对米哈游的一些看法

在来米哈游之前，我通过反编译游戏的代码已经大概了解了的客户端代码，依然察觉到一些问题，正式接手工作之后，问题比我想象的要多。以下问题按重要性递减：

1.  UnityScript作为客户端脚本
2. 游戏中基本没有MonoBehaviour脚本，强行使用MVC分层
3.  触摸层级和界面跳转的混乱加灾难
4.  配置硬编码 + 没有使用ProtoBuf作为DSL生成协议‘
5.  没有消息传送机制，GameObject之间的通讯没办法解耦， 太多的GameObject.Find极大拉低了游戏的整体效率。
6.  Profile不受重视

在接下来的几个月里，问题1在大家的努力下，终于解决了，客户端全部换成C#，虽然其中颇多曲折，但最终大家还是能够一起开心的在VS上玩耍了。

问题2 其实是设计思路的问题，首先MVC本身就不太适合作为现在的客户端游戏架构，接下来我会写一些博客讲一下我理想中的MVVM架构。

但除了MVC架构的错误之外，更大的问题是游戏中的MonoBehavior都没有绑定在GameObject上，而是由MonoBehavior创建GameObject，导致脚本和对象之间的互相调用十分麻烦，不过这个问题仍属于设计思路的问题。

问题3 我已经提出了一些解决方案，应该在下几个版本里面就会进行修改。

问题4 这个仍然是历史问题，我自己写了一套类似ProtoBuf的东西来解决了这个问题，同时大家也在积极地重构从前的Code。

问题5 我已经提出了解决方案，但是由于遗留代码的问题，在短期内仍然无法变更。

问题6 我尽力Push大家一起Profile

###我在米哈游干了什么

在米哈游的这几个月里面，除了完成了本职范围内的功能开发外，我还干了以下这些事：

####优化了碰撞系统

碰撞优化就是把每一帧的碰撞进行预处理，将一些碰撞数据缓存起来，存了一个<碰撞条件，碰撞物体>的字典，每一帧清理，有时命中率能达到80~90%，这样在这一帧之后的碰撞中就不再需要重复计算了，在新关卡中可以提高10FPS左右。

####优化了内存系统

内存优化，在UI中，对游戏中比较大的内存分配进行追踪，比如进入游戏后的关卡图，每个占5M，如果玩家顺序滑动，之后会占用5 * 20，大概100M的无用内存，经过优化之后，可以使得每次 Load 5 张图左右，进行一次回收，使得内存占用不会超过40M了。

####优化了界面构建流程

第一，使用NGUI重做了一些界面，第二，构建了界面栈系统（仍然没有投入使用）。

界面栈可以类比Cocos2dx中的Push，Pop场景那里，把不同的界面当作栈中的一层进行处理，每次进入一个大的界面的时候，把上一个界面的状态信息压入界面栈中，这样就能比较好的处理界面的跳转问题，相关代码，可以参考我的开源项目：[StateManager.cs](https://github.com/MrNerverDie/MiniWeChat-Client/blob/master/Assets/Script/Model/GameRoot/StateManager/StateManager.cs)

####为客户端加入以JSON为DSL的数据结构生成器

可以根据一个配置的JSON文件来直接生成相应的读表程序和数据结构，这样崩坏所有的数据结构格式都可以由策划来配置，配置完毕后，直接生成相应的代码即可，其功能可以类比ProtoBuf。

##MiniWeChat

###项目介绍

迷你微信是一个使用Unity3D制作的微信客户端，同时我们还用Mina，Spring和Hibernate做了MiniWeChat的后端。实现了用户管理，点对点聊天，群组聊天等功能。

###从MVC到MVVM

MVC是一种非常有价值的架构思路，然而时代在变迁，随着以windows系为代表的WIMP（window、icon、menu、pointer）风格的应用逐渐成为主流，人们发现，view和controller某些部件之间的局部性实际上强于controller内部的局部性。于是一种叫做控件（control）的预制组件开始出现了。

Prefab本身带有一定的交互功能，从MVC的视角来看，它既包含view，又包含controller，并且它通过"属性"，来把用户输入暴露给model。

controller的输入分配功能，则被操作系统提供的各种机制取代。

Prefab其实是U3D引入的中一种非常先进的开发思路，它和Windows开发中的控件，Web开发中的HTML一样，用标记语言来描述View。

在这样的架构中，view（或者说叫控件），不但是从依赖关系上跟程序的其他部件解耦，而且从语言上跟其它部分隔离开来。

标记语言的好处是，它可以由非专业的程序员产生，通过工具或者经过简单培训，一些设计师可以直接产生用标记语言描述的UI。想要突破这个限制使得view跟其它部分异常耦合可能性也更低。

然而这样的系统架构中，MVC和MVP模式已经不能很好地适用了。微软架构师John Gossman在WPF的XAML模式推出的同时，提出了MVVM的概念。

WPF得MVVM正式说明了它的view的概念跟MVC中的view的概念的区别。这里简单画了一下：

![Alt text](./1429679939754.png)

在MVVM模式中，数据绑定是最重要的概念，在MVC和MVP中的view和model的互相通讯，被以双向绑定的方式替代，这进一步把逻辑代码变成了声明模式。

###长连接和协议制定

MiniWeChat使用基于Socket的长连接，使用protobuf作为客户端和服务器之间的数据交换格式。

由于客户端会把数据存储在本地，一起向服务器发起的请求都以超时作为处理的标准。

###GameRoot和单例生命期

对于大型复杂软件开发，软件中对象的初始化顺序和销毁顺序非常重要。由于项目都是多人并行开发，对于所有单键类的对象初始化与销毁，必须有一个统一可控的初始化顺序。所以我决定将所有单例的创建和销毁放在同一个地方，便于管理。

我使用GameRoot统一控制它们的初始化顺序和销毁顺序。 同时，在创建单例的时候可以把其顺序通过匿名函数记录下来，这样在销毁的时候可以按照创建顺序的反序执行。

###非阻塞的服务器编程



##想问的问题

* 我在这次面试中的缺点？
* 网络协议的数据包有没有加密？如果加密了使用什么方式加密？客户端如何实现加密？
* 如何处理断线重连？
* 为何不做3D或者PVP模式，如果做了遇到了那些困难啊？
* 如何看待单例？
* 完美世界有什么开源项目？完美世界有哪些针对U3D开发的性能分析工具或者框架。



